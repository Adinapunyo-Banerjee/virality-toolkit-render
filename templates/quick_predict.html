{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% block title %} Quick Predict {% endblock %}
{% block css %}
<link rel="stylesheet" href="{%static '/css/quick_predict.css' %}">
{% endblock %}

{% block content %}

<!-- Main Content -->

<!-- Response Error Message -->
<div id="response_error"
    class="close_on_click_error alert alert-error absolute text-center mt-5 mx-auto max-w-max z-50 left-0 right-0 text-sm content-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="response_error_msg">Hello!</span>
    <i onclick="messageDismiss('close_on_click_error')" class="fa-solid fa-xmark"></i>
</div>

<!-- Response Success Message -->
<div id="response_success"
    class="close_on_click_success alert alert-success absolute text-center mt-5 mx-auto max-w-max z-50 left-0 right-0 text-sm content-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="response_success_msg">Hello!</span>
    <i onclick="messageDismiss('close_on_click_success')" class="fa-solid fa-xmark"></i>
</div>

<!-- Response Warning Message -->
<div id="response_warning"
    class="close_on_click_warn alert alert-warning absolute text-center mt-5 mx-auto max-w-max z-50 left-0 right-0 text-sm content-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg></svg>
    <span id="response_warning_msg">Hello!</span>
    <i onclick="messageDismiss('close_on_click_warn')" class="fa-solid fa-xmark"></i>
</div>

<script>
    // Hide AJAX response messages 
    $("#response_error").hide();
    $("#response_success").hide();
    $("#response_warning").hide();
</script>

<div class="text-sm breadcrumbs px-10 bg-base-200 text-base-content">
    <ul>
        <li><a href="{% url 'home' %}">Home</a></li>
        <li><a href="{% url 'tools' %}">Tools</a></li>
        <li><a>Quick Predict</a></li>
    </ul>
</div>

<div class="hero"
    style="background-image: url({% static '/images/yt4.jfif' %});">
    <div class="hero-overlay bg-opacity-60"></div>
    <div class="hero-content text-center text-neutral-content h-[40vh]">
        <div class="max-w-md">
            <h1 class="mb-5 text-5xl font-bold brightness-150 contrast-150">Quick Predict</h1>
            <p class="mb-2">Quickly predict the popularity of your thumbnail today.</p>
            <p class="mb-5">
                <i class="fa-solid fa-star-half-stroke"></i>
                <i class="fa-regular fa-star"></i>
                <i class="fa-regular fa-star"></i>
                <i class="fa-regular fa-star"></i>
                <i class="fa-regular fa-star"></i>
            </p>
        </div>
    </div>
</div>

<form class="flex flex-col md:flex-row bg-base-200 px-10 py-10" action="" method="post" enctype="multipart/form-data">

    <div id="drag_and_drop" data-tip="Maximum size of 5MB"
        class="max-sm:max-md:py-5 input-div border-2 border-dashed border-primary rounded-md flex justify-center md:w-1/2 md:h-[200px] align-center text-center relative tooltip tooltip-info">
        <p class="input-change my-auto">Drag & drop your thumbnail here or <strong>Browse</strong></p>
        <input type="file" class="file w-full h-full absolute opacity-0 cursor-pointer" accept="image/*" name="thumb"
            required id="id_thumb">
    </div>

    <div id="additional_data" class="md:w-1/2 w-full py-6 md:py-0 px-5 flex flex-col gap-3">
        <div class="">
            <select name="category" required id="id_category" class="select select-accent w-full max-w-xs">
                <option value="" selected="">Select category</option>
                <option value="1">Film and Animation</option>
                <option value="2">Autos and Vehicles</option>
                <option value="10">Music</option>
                <option value="15">Pets and Animals</option>
                <option value="17">Sports</option>
                <option value="18">Short Movies</option>
                <option value="19">Travel and Events</option>
                <option value="20">Gaming</option>
                <option value="21">Video Blogging</option>
                <option value="22">People and Blogs</option>
                <option value="23">Comedy</option>
                <option value="24">Entertainment</option>
                <option value="25">News and Politics</option>
                <option value="26">Howto and Style</option>
                <option value="27">Education</option>
                <option value="28">Science and Technology</option>
                <option value="29">Nonprofits and Activism</option>
                <option value="30">Movies</option>
                <option value="31">Anime/Animation</option>
                <option value="32">Action/Adventure</option>
                <option value="33">Classics</option>
                <option value="35">Documentary</option>
                <option value="36">Drama</option>
                <option value="37">Family</option>
                <option value="38">Foreign</option>
                <option value="39">Horror</option>
                <option value="40">Sci-Fi/Fantasy</option>
                <option value="41">Thriller</option>
                <option value="42">Shorts</option>
                <option value="43">Shows</option>
                <option value="44">Trailer</option>
            </select>
            
            <div class="pl-1 inline-block tooltip"
                data-tip="Every YouTube video has a specific category be it Gaming or Entertainment">
                <i class="fa-regular fa-circle-question"></i>
            </div>
        </div>

        <div>
            <label for="id_subscribers" class="px-1">Subscribers:</label> <br>
            <input id="id_subscribers" type="number" placeholder="Type here"
                class="input input-bordered input-accent w-full max-w-xs" name="subscribers" value="0" required
                min="0" />
        </div>

        <div>
            <label for="id_channel_pub_time" class="px-1">Channel publish time:</label> <br>
            <input id="id_channel_pub_time" type="datetime-local"
                class="input input-bordered input-accent w-full max-w-xs" name="channel_pub_time" required />
            <input type="hidden" name="initial-channel_pub_time" value="2023-05-02 20:30:04"
                id="initial-id_channel_pub_time">
            <div class="pl-1 inline-block tooltip"
                data-tip="The date and time of publishing your channel. Time is optional ofcourse.">
                <i class="fa-regular fa-circle-question"></i>
            </div>
        </div>

        <div>
            <label for="id_video_pub_time" class="px-1">Video publish time:</label> <br>
            <input id="id_video_pub_time" type="datetime-local"
                class="input input-bordered input-accent w-full max-w-xs" name="video_pub_time" required />
            <input type="hidden" name="initial-video_pub_time" value="2023-05-02 20:30:04"
                id="initial-id_video_pub_time">
            <div class="pl-1 inline-block tooltip"
                data-tip="The date and time of publishing your video. Time is optional again.">
                <i class="fa-regular fa-circle-question"></i>
            </div>
        </div>

        <div>
            <label for="id_videos" class="px-1">Total Videos:</label> <br>
            <input value="0" id="id_videos" min="0" type="number"
                class="input input-bordered input-accent w-full max-w-xs" name="videos" required />
            <div class="pl-1 inline-block tooltip" data-tip="Total number of videos you have made. Including Shorts">
                <i class="fa-regular fa-circle-question"></i>
            </div>
        </div>

        <div>
            <label for="id_views" class="px-1">Total Views:</label> <br>
            <input value="0" id="id_views" min="0" type="number"
                class="input input-bordered input-accent w-full max-w-xs" name="videos" required />
            <div class="pl-1 inline-block tooltip" data-tip="Total number of views your channel has achieved.">
                <i class="fa-regular fa-circle-question"></i>
            </div>
        </div>

        <b>
            Token Cost: 1
        </b>

        <div class="flex gap-3">
            <a id="predict_btn" class="btn btn-outline md:w-[20%]">Predict </a>
            <span id="loader" class="loading loading-ring loading-lg float hidden"></span>
        </div>
    </div>

</form>

<div id="pr" class="px-10 bg-base-200 text-center hidden">
    <div id="pr_title" class="text-3xl font-bold text-primary-focus">
        Prediction results
    </div>
    <div id="likes" class="text-lg">
        Likes: <b id="fill_likes"></b>
    </div>
    <div id="views" class="text-lg">
        Views: <b id="fill_views"></b>
    </div>
</div>

<div class="px-10 py-10 bg-gradient-to-b from-base-200 to-base-300">
    <i class="fa-solid fa-circle-exclamation"></i> Please remember that Virality Toolkit is an experiment. The AI
    may not provide you with the best results yet!
</div>
<!-- Main Content End -->

<!-- Footer -->
<footer class="footer footer-center p-10 bg-primary text-primary-content">
    <div>
        <svg width="50" height="50" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd"
            clip-rule="evenodd" class="inline-block fill-current">
            <path
                d="M22.672 15.226l-2.432.811.841 2.515c.33 1.019-.209 2.127-1.23 2.456-1.15.325-2.148-.321-2.463-1.226l-.84-2.518-5.013 1.677.84 2.517c.391 1.203-.434 2.542-1.831 2.542-.88 0-1.601-.564-1.86-1.314l-.842-2.516-2.431.809c-1.135.328-2.145-.317-2.463-1.229-.329-1.018.211-2.127 1.231-2.456l2.432-.809-1.621-4.823-2.432.808c-1.355.384-2.558-.59-2.558-1.839 0-.817.509-1.582 1.327-1.846l2.433-.809-.842-2.515c-.33-1.02.211-2.129 1.232-2.458 1.02-.329 2.13.209 2.461 1.229l.842 2.515 5.011-1.677-.839-2.517c-.403-1.238.484-2.553 1.843-2.553.819 0 1.585.509 1.85 1.326l.841 2.517 2.431-.81c1.02-.33 2.131.211 2.461 1.229.332 1.018-.21 2.126-1.23 2.456l-2.433.809 1.622 4.823 2.433-.809c1.242-.401 2.557.484 2.557 1.838 0 .819-.51 1.583-1.328 1.847m-8.992-6.428l-5.01 1.675 1.619 4.828 5.011-1.674-1.62-4.829z">
            </path>
        </svg>
        <p class="font-bold">
            Virality Toolkit <br />
        </p>
        <p>Copyright © 2023 - All right reserved</p>
    </div>
    <div>
        <div class="grid grid-flow-col gap-4">
            <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current">
                    <path
                        d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z">
                    </path>
                </svg></a>
            <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current">
                    <path
                        d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z">
                    </path>
                </svg></a>
            <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current">
                    <path
                        d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z">
                    </path>
                </svg></a>
        </div>
    </div>
</footer>
</body>

<script>

    // Make 'cookies_accepted' storage
    if (localStorage.getItem("cookies_accepted") == null) {
        localStorage.setItem("cookies_accepted", "false");
        console.log("Item Set...")
    }

    // Cookie Notice
    if (localStorage.getItem("cookies_accepted") == "false") {
        cookie_notice = document.getElementById("cookie_notice");
        cookie_notice.setAttribute("class", "absolute close_on_click_cookies drop-shadow-xl alert mt-5 mx-auto max-w-max left-0 right-0 text-sm content-center z-[52]");
        console.log("Cookies not yet accepted.");
    }

    // If cookie accepted
    function cookieAccepted() {
        localStorage.setItem("cookies_accepted", "true");
        console.log("Accepted!");
    }

    function messageDismiss(class_name_to_dismiss) {
        let btn = document.getElementsByClassName(class_name_to_dismiss);
        for (let i = 0; i < btn.length; i++) {
            btn[i].style.top = "0";
            btn[i].style.display = "none"
        }
    }
</script>


<script>
    if (localStorage.getItem("theme_set") == null) {
        localStorage.setItem("theme_set", "dark");
    }
    else {
        let theme_set = localStorage.getItem("theme_set");
        console.log(theme_set);
        let name_common_styles = "btn btn-ghost normal-case text-xl bg-clip-text text-transparent bg-gradient-to-r bg-clip-text text-transparent";
        let highlight_common_styles = "highlight text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r";

        // Gradients here!
        const theme_gradients = {
            "light": "from-fuchsia-500 to-cyan-500",
            "dark": "from-fuchsia-500 to-cyan-500",
            "bumblebee": "from-yellow-400 via-amber-500 to-yellow-400",
            "synthwave": "from-teal-500 via-pink-400 to-amber-500",
            "retro": "from-teal-600 via-pink-600 to-yellow-600",
            "luxury": "from-fuchsia-600 via-yellow-500 to-amber-600",
            "autumn": "from-red-400 via-rose-700 to-rose-300",
            "aqua": "from-pink-300 via-cyan-300 to-yellow-200",
            "cyberpunk": "from-cyan-500 via-rose-400 to-fuchsia-600",
            "night": "from-violet-500 via-cyan-400 to-pink-600"
        }

        // Now change the theme
        changeTheme(theme_set, name_common_styles + " " + theme_gradients[theme_set], highlight_common_styles + " " + theme_gradients[theme_set]);
    }

    function changeTheme(new_theme, gradient_theme, highlight_gradient_theme) {
        // Change DaisyUI theme
        let html_ele = document.getElementById("the_html");
        html_ele.setAttribute("data-theme", new_theme);

        // Store new theme name in local storage
        localStorage.setItem("theme_set", new_theme);

        // Get App name and highlights
        let app_name = document.getElementById("app_name");
        let highlights = document.getElementsByClassName("highlight");

        // Change all highlights and App Name
        for (let i = 0; i < highlights.length; i++) {
            highlights[i].setAttribute("class", highlight_gradient_theme);
        }
        app_name.setAttribute("class", gradient_theme);
        // Also change the gradient colours of highlighted text and Name here!
    }
</script>

<script>
    // Drag and Drop functionality Javascript
    const inputDiv = document.querySelector(".input-div")
    const input = document.querySelector("#id_thumb")
    const output = document.querySelector("output")
    let imagesArray = []

    input.addEventListener("change", () => {
        const files = input.files
        for (let i = 0; i < files.length; i++) {
            imagesArray.push(files[i])
        }
        displayImages()
    })

    inputDiv.addEventListener("drop", () => {
        e.preventDefault()
        const files = e.dataTransfer.files
        for (let i = 0; i < files.length; i++) {
            if (!files[i].type.match("image")) continue;
            if (imagesArray.every(image => image.name !== files[i].name))
                imagesArray.push(files[i])
        }
        displayImages()
    })

    function displayImages() {
        let images = ""
        imagesArray.forEach((image, index) => {
            images += `<div class="image">
                    <img src="${URL.createObjectURL(image)}" alt="image" style="max-height:200px">
              </div>`
        })
        document.querySelector(".input-change").innerHTML = images
    }

    const data_in = document.querySelector("#additional_data");
    h = window.getComputedStyle(data_in, null).getPropertyValue('height');
    console.log(h);
    const dnd = document.querySelector("#drag_and_drop");
    dnd.style.height = h;
</script>

<script>
    // Form validation Javascript
    function checkFileSize() {
        var fileUpload = document.getElementById("id_thumb");

        // Check if file is uploaded or not
        if (fileUpload.files[0] == undefined) {
            alert("Upload a file first! (Less than 5MB)");
            return false;
        }

        // Checking file upload size
        var size = parseFloat(fileUpload.files[0].size / 1024).toFixed(2);
        if (size > 5000) {
            alert("File size is greater than 5MB!");
            return false;
        }
        return true;
    };

    function checkDate(id_name) {
        var input_date = document.getElementById(id_name).value;

        if (input_date == "") {
            alert("No date chosen!");
            return false;
        }

        var new_date = new Date(input_date);
        var now_date = new Date();

        if (new_date > now_date) {
            alert("Date should be before today!");
            return false;
        }

        return true;
    }

    function checkDateDistance(chann_date, vid_date) {
        var channel = document.getElementById(chann_date).value;
        var video = document.getElementById(vid_date).value;

        if (channel == "" || video == "") return false;

        var channel_date = new Date(channel);
        var video_date = new Date(video);

        if (video_date < channel_date) {
            alert("Channel date should be before Video publish date");
            return false;
        }

        return true;
    }

    function checkCategory() {
        var input_cat = document.getElementById("id_category").value;
        if (input_cat == "") {
            alert("Select a video category!");
            return false;
        }
        else return true;
    }

    $(document).ready(() => {
        $('#predict_btn').on('click', () => {
            console.log("Button clicked");
            var file_size_check = checkFileSize();
            var cat_check = checkCategory();
            var chann_check = checkDate("id_channel_pub_time");
            var vid_check = checkDate("id_video_pub_time");
            var date_dist = checkDateDistance("id_channel_pub_time", "id_video_pub_time");
            if (file_size_check && cat_check && chann_check && vid_check && date_dist) {
                const category = document.getElementById("id_category").value;
                const subs = document.getElementById("id_subscribers").value;
                const cpt = document.getElementById("id_channel_pub_time").value;
                const vpt = document.getElementById("id_video_pub_time").value;
                const videos = document.getElementById("id_videos").value;
                const views = document.getElementById("id_views").value;
                const img_data = document.getElementById("id_thumb").files[0];

                // console.log(category);
                // console.log(subs);
                // console.log(cpt);
                // console.log(vpt);
                // console.log(videos);
                // console.log(views);
                // console.log(img_data);

                var fd = new FormData();
                console.log(fd);
                fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                console.log(fd);
                fd.append('thumb', img_data);
                fd.append('category', category);
                fd.append('subscribers', subs);
                fd.append('channel_pub_time', cpt);
                fd.append('video_pub_time', vpt);
                fd.append('videos', videos);
                fd.append('views', views);

                console.log(fd);


                $('#loader').show();
                $('#pr').slideUp(500);
                $.ajax({
                    type: 'POST',
                    url: '',
                    enctype: 'multipart/form-data',
                    data: fd,
                    success: function (response) {
                        // Hide loader again
                        $('#loader').hide();

                        // Show messages if any
                        for (i = 0; i < response['messages'].length; i++)
                        {
                            var msg = response['messages'][i];
                            if (msg['error'])
                            {
                                $("#response_error_msg").text(msg['error']);
                                $("#response_error").show();
                                // console.log('Error message recieved: ' + msg['error']);
                            }
                            else if (msg['success'])
                            {
                                $("#response_success_msg").text(msg['success']);
                                $("#response_success").show();
                                // console.log('Success message recieved: ' + msg['success']);
                            }
                            else if (msg['warning'])
                            {
                                $("#response_warning_msg").text(msg['warning']);
                                $("#response_warning").show();
                                // console.log('Warning message recieved: ' + msg['warning']);
                            }
                        }

                        if (response['result_data'])
                        {
                            // Fill the data in #pr
                            $("#fill_likes").text(response['result_data']['likes']);
                            $("#fill_views").text(response['result_data']['views']);
                            // console.log(response['result_data']['likes'] + " " + response['result_data']['views']);
                            $('#pr').slideDown(500);
                        }

                        if(response['tokens']) $("#token_balance").text(response['tokens']);
                    },
                    error: function (error)
                    {
                        $("#response_error_msg").text("There was a problem processing your request!");
                        $("#response_error").show();
                        $('#loader').hide();
                    },
                    cache: false,
                    contentType: false,
                    processData: false,
                });
            }
        });
    });
</script>

{% endblock %}